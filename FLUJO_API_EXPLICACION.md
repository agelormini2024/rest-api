# üìö Documentaci√≥n: Flujo Completo de la REST API

## üéØ Introducci√≥n

Esta documentaci√≥n explica de manera did√°ctica c√≥mo funciona el flujo completo de una REST API construida con Node.js, Express, PostgreSQL y Prisma ORM. Incluye arquitectura modular, manejo de errores espec√≠ficos de PostgreSQL, y implementa dos patrones de almacenamiento: usuarios simulados en memoria y productos en base de datos real.

---

## üèóÔ∏è Arquitectura General

```
rest-api/
‚îú‚îÄ‚îÄ server.js              # üö™ Punto de entrada principal
‚îú‚îÄ‚îÄ prisma.js              # üóÑÔ∏è Cliente de Prisma configurado
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.js             # üß† Configuraci√≥n central de Express
‚îÇ   ‚îú‚îÄ‚îÄ controllers/       # üéÆ L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userController.js      # Usuarios (memoria)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ productoController.js  # Productos (PostgreSQL)
‚îÇ   ‚îú‚îÄ‚îÄ models/            # üìù Modelos de datos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ User.js        # Modelo simulado de usuario
‚îÇ   ‚îú‚îÄ‚îÄ routes/            # üõ£Ô∏è Definici√≥n de rutas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userRoutes.js          # Endpoints de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ productoRoutes.js      # Endpoints de productos
‚îÇ   ‚îú‚îÄ‚îÄ middleware/        # üõ°Ô∏è Funciones intermedias
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorMiddleware.js     # Manejo errores PostgreSQL
‚îÇ   ‚îî‚îÄ‚îÄ config/            # ‚öôÔ∏è Configuraciones
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma      # üìä Esquema de base de datos
‚îÇ   ‚îî‚îÄ‚îÄ migrations/        # üîÑ Historial de migraciones
‚îú‚îÄ‚îÄ .env                   # üîí Variables de entorno + DATABASE_URL
‚îú‚îÄ‚îÄ package.json           # üì¶ Dependencias y scripts
‚îî‚îÄ‚îÄ api.http              # üß™ Tests de endpoints
```

---

## üöÄ Flujo Completo de una Petici√≥n HTTP

### 1. **Punto de Entrada: `server.js`**

```
üåê Cliente hace petici√≥n ‚Üí üì° Puerto 3000 ‚Üí server.js
```

**Responsabilidades:**
- Escucha en el puerto configurado (3000 por defecto)
- Carga las variables de entorno desde `.env`
- Importa y ejecuta la configuraci√≥n de la app
- Maneja el cierre graceful del servidor

```javascript
// server.js - El portero principal
import app from './src/app.js';
import dotenv from 'dotenv';

dotenv.config();
const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`üöÄ Servidor ejecut√°ndose en puerto ${PORT}`);
});
```

---

### 2. **Configuraci√≥n Central: `src/app.js`**

```
üì° Petici√≥n llega ‚Üí üîß Middleware Stack ‚Üí üõ£Ô∏è Rutas
```

**Stack de Middleware (ORDEN CR√çTICO):**

```javascript
// app.js - El cerebro que procesa todo
const app = express();

// 1Ô∏è‚É£ SEGURIDAD
app.use(helmet()); // A√±ade headers de seguridad HTTP

// 2Ô∏è‚É£ LOGGING
app.use(morgan('combined')); // Registra cada petici√≥n HTTP

// 3Ô∏è‚É£ PARSING
app.use(express.json({ limit: '10mb' })); // Convierte JSON ‚Üí Objeto JS
app.use(express.urlencoded({ extended: true })); // Parse form data

// 4Ô∏è‚É£ CORS
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true
}));

// 5Ô∏è‚É£ RUTAS
app.use('/api/users', userRoutes);

// 6Ô∏è‚É£ ERROR HANDLERS (SIEMPRE AL FINAL)
app.use(notFound);
app.use(errorHandler);
```

**Flujo de Procesamiento:**
```
Petici√≥n ‚Üí Helmet ‚Üí Morgan ‚Üí JSON Parser ‚Üí CORS ‚Üí Rutas ‚Üí Error Handler
```

---

## üîÑ Ejemplos Pr√°cticos de Flujo

### **Ejemplo 1: GET /api/users**

#### **Petici√≥n:**
```http
GET http://localhost:3000/api/users
```

#### **Flujo Paso a Paso:**

**1. Enrutamiento:**
```javascript
// app.js - L√≠nea que dirige el tr√°fico
app.use('/api/users', userRoutes);
```

**2. Identificaci√≥n de Ruta:**
```javascript
// userRoutes.js - Encuentra la funci√≥n exacta
router.route('/')
  .get(getUsers)  // ‚Üê Aqu√≠ coincide GET /api/users
```

**3. Ejecuci√≥n del Controlador:**
```javascript
// userController.js - L√≥gica de negocio
export const getUsers = asyncHandler(async (req, res) => {
  const users = User.findAll(); // ‚Üê Llama al modelo
  
  res.json({
    success: true,
    count: users.length,
    data: users
  });
});
```

**4. Procesamiento en el Modelo:**
```javascript
// User.js - Acceso a datos
static findAll() {
  return users; // Devuelve el array de usuarios en memoria
}
```

**5. Respuesta Final:**
```json
{
  "success": true,
  "count": 3,
  "data": [
    { "id": 1, "name": "Juan P√©rez", "email": "juan@email.com", "age": 25 },
    { "id": 2, "name": "Mar√≠a Garc√≠a", "email": "maria@email.com", "age": 30 },
    { "id": 3, "name": "Carlos L√≥pez", "email": "carlos@email.com", "age": 28 }
  ]
}
```

---

### **Ejemplo 2: POST /api/users (Crear Usuario)**

#### **Petici√≥n:**
```http
POST http://localhost:3000/api/users
Content-Type: application/json

{
  "name": "Ana Mart√≠nez",
  "email": "ana@email.com",
  "age": 27
}
```

#### **Flujo Detallado:**

```
üì® POST /api/users con JSON body
    ‚Üì
üîß express.json() - Convierte el JSON en req.body
    ‚Üì
üõ£Ô∏è userRoutes.js - router.route('/').post(createUser)
    ‚Üì
üéÆ userController.js - createUser()
    ‚Üì 
üîç Validaci√≥n de entrada (name, email, age requeridos)
    ‚Üì
üìù User.js - User.create(userData)
    ‚Üì
‚úÖ Validaci√≥n del modelo + verificaci√≥n email √∫nico
    ‚Üì
üíæ Almacenamiento en array users[]
    ‚Üì
üì§ Respuesta JSON con status 201
```

#### **En el Controlador:**
```javascript
export const createUser = asyncHandler(async (req, res) => {
  const { name, email, age } = req.body; // ‚Üê Datos parseados por express.json()
  
  // Validaci√≥n de entrada
  if (!name || !email || !age) {
    res.status(400);
    throw new Error('Por favor proporciona name, email y age');
  }

  const user = User.create({ name, email, age }); // ‚Üê Delegaci√≥n al modelo

  res.status(201).json({
    success: true,
    data: user
  });
});
```

#### **En el Modelo:**
```javascript
static create(userData) {
  const user = new User(userData);
  const errors = user.validate(); // ‚Üê Validaci√≥n interna
  
  if (errors.length > 0) {
    throw new Error(errors.join(', '));
  }

  // Verificaci√≥n de email √∫nico
  if (users.some(u => u.email === user.email)) {
    throw new Error('El email ya est√° registrado');
  }

  users.push(user); // ‚Üê Persistencia en memoria
  return user;
}
```

---

### **Ejemplo 3: GET /api/productos (Con PostgreSQL + Prisma)**

#### **Petici√≥n:**
```http
GET http://localhost:3000/api/productos
```

#### **Flujo Paso a Paso:**

**1. Enrutamiento:**
```javascript
// app.js - L√≠nea que dirige el tr√°fico
app.use('/api/productos', productoRoutes);
```

**2. Identificaci√≥n de Ruta:**
```javascript
// productoRoutes.js - Encuentra la funci√≥n exacta
router.route('/')
  .get(getProductos)  // ‚Üê Aqu√≠ coincide GET /api/productos
```

**3. Ejecuci√≥n del Controlador:**
```javascript
// productoController.js - L√≥gica de negocio
export const getProductos = asyncHandler(async (req, res) => {
  const productos = await prisma.producto.findMany(); // ‚Üê Consulta a PostgreSQL
  
  res.json({
    success: true,
    count: productos.length,
    data: productos
  });
});
```

**4. Procesamiento con Prisma:**
```javascript
// prisma.js - Cliente configurado
import { PrismaClient } from '@prisma/client';
export const prisma = globalThis.prisma || new PrismaClient();

// La consulta prisma.producto.findMany() genera:
SELECT id, nombre, descripcion, precio, stock, "createdAt", "updatedAt" 
FROM "Producto";
```

**5. Respuesta Final:**
```json
{
  "success": true,
  "count": 2,
  "data": [
    {
      "id": 1,
      "nombre": "Notebook Lenovo",
      "descripcion": "Laptop para oficina",
      "precio": "1200.50",
      "stock": 5,
      "createdAt": "2025-09-06T10:30:00.000Z",
      "updatedAt": "2025-09-06T10:30:00.000Z"
    },
    {
      "id": 2,
      "nombre": "Mouse Logitech",
      "descripcion": "Mouse inal√°mbrico",
      "precio": "25.99",
      "stock": 15,
      "createdAt": "2025-09-06T10:35:00.000Z",
      "updatedAt": "2025-09-06T10:35:00.000Z"
    }
  ]
}
```

---

### **Ejemplo 4: POST /api/productos (Crear Producto con BD Real)**

#### **Petici√≥n:**
```http
POST http://localhost:3000/api/productos
Content-Type: application/json

{
  "nombre": "Teclado Mec√°nico",
  "descripcion": "Teclado gaming RGB",
  "precio": 89.99,
  "stock": 10
}
```

#### **Flujo Detallado:**

```
üì® POST /api/productos con JSON body
    ‚Üì
üîß express.json() - Convierte el JSON en req.body
    ‚Üì
üõ£Ô∏è productoRoutes.js - router.route('/').post(createProducto)
    ‚Üì
üéÆ productoController.js - createProducto()
    ‚Üì 
üîç Validaci√≥n de entrada (nombre, precio, stock requeridos)
    ‚Üì
üóÑÔ∏è prisma.producto.create() - INSERT a PostgreSQL
    ‚Üì
‚úÖ Validaci√≥n de BD + restricciones PostgreSQL
    ‚Üì
üíæ Almacenamiento en tabla "Producto"
    ‚Üì
üì§ Respuesta JSON con status 201
```

#### **En el Controlador:**
```javascript
export const createProducto = asyncHandler(async (req, res) => {
  const { nombre, descripcion, precio, stock } = req.body;

  // Validaci√≥n de entrada
  if (!nombre || !precio || stock === undefined) {
    res.status(400);
    throw new Error('Por favor proporciona nombre, precio y stock');
  }

  // Inserci√≥n en PostgreSQL via Prisma
  const producto = await prisma.producto.create({
    data: { nombre, descripcion, precio, stock }
  });

  res.status(201).json({
    success: true,
    data: producto
  });
});
```

#### **Query SQL Generada por Prisma:**
```sql
INSERT INTO "Producto" (nombre, descripcion, precio, stock, "createdAt", "updatedAt") 
VALUES ($1, $2, $3, $4, NOW(), NOW()) 
RETURNING id, nombre, descripcion, precio, stock, "createdAt", "updatedAt";
```

#### **Ventajas de Prisma sobre SQL directo:**
- ‚úÖ **Tipado autom√°tico** - Autocompletado en VS Code
- ‚úÖ **Validaci√≥n de esquema** - Errores en tiempo de compilaci√≥n
- ‚úÖ **Prevenci√≥n de SQL Injection** - Queries parametrizadas
- ‚úÖ **Migraciones autom√°ticas** - Control de versiones de BD
- ‚úÖ **Generaci√≥n de clientes** - API consistente

---

## üõ°Ô∏è Manejo de Errores

### **Flujo de Error:**

```
‚ùå Error en cualquier punto del flujo
    ‚Üì
üõ°Ô∏è asyncHandler() - Captura autom√°tica de errores async
    ‚Üì
üö® errorHandler() - Middleware de manejo de errores
    ‚Üì
üì§ Respuesta de error estandarizada
```

### **Tipos de Errores Manejados (PostgreSQL):**

1. **Errores de Conexi√≥n (503):**
```javascript
// Error: Base de datos no disponible
{
  "success": false,
  "error": "Error de conexi√≥n a la base de datos"
}
```

2. **Errores de Restricci√≥n √önica - PostgreSQL 23505 (400):**
```javascript
// Error: Email duplicado
{
  "success": false,
  "error": "El email ya existe. Debe ser √∫nico.",
  "code": "23505",  // Solo en desarrollo
  "detail": "Key (email)=(test@email.com) already exists."
}
```

3. **Errores de Campo Obligatorio - PostgreSQL 23502 (400):**
```javascript
// Error: Campo NOT NULL
{
  "success": false,
  "error": "El campo 'name' es obligatorio"
}
```

4. **Errores de Clave For√°nea - PostgreSQL 23503 (400):**
```javascript
// Error: Referencia inexistente
{
  "success": false,
  "error": "Referencia a un recurso que no existe"
}
```

5. **Errores de Validaci√≥n - PostgreSQL 23514 (400):**
```javascript
// Error: Restricci√≥n check
{
  "success": false,
  "error": "Los datos no cumplen con las restricciones de validaci√≥n"
}
```

6. **Errores de ID Inv√°lido (400):**
```javascript
// Error: UUID/Integer malformado
{
  "success": false,
  "error": "ID proporcionado no es v√°lido"
}
```

7. **Errores de Tipo de Dato - PostgreSQL 22P02 (400):**
```javascript
// Error: Formato incorrecto
{
  "success": false,
  "error": "Formato de datos inv√°lido"
}
```

8. **Errores de Recurso No Encontrado (404):**
```javascript
// Error: Usuario con ID inexistente
{
  "success": false,
  "error": "Usuario no encontrado"
}
```

9. **Errores de Ruta No Encontrada (404):**
```javascript
// Error: Endpoint inexistente
{
  "success": false,
  "error": "Ruta no encontrada - /api/productos"
}
```

10. **Errores Internos del Servidor (500):**
```javascript
// Error: SQL syntax o tabla inexistente
{
  "success": false,
  "error": "Error interno del servidor - Consulta SQL inv√°lida"
}
```

### **C√≥digos de Error PostgreSQL Principales:**

| C√≥digo         | Descripci√≥n                     | Status HTTP | Ejemplo                   |
|----------------|---------------------------------|-------------|---------------------------|
| `23505`        | Violaci√≥n restricci√≥n √∫nica     | 400         | Email duplicado           |
| `23502`        | Violaci√≥n NOT NULL              | 400         | Campo obligatorio         |
| `23503`        | Violaci√≥n clave for√°nea         | 400         | ID referenciado no existe |
| `23514`        | Violaci√≥n restricci√≥n check     | 400         | Edad negativa             |
| `42601`        | Error sintaxis SQL              | 500         | Query malformado          |
| `42P01`        | Tabla no existe                 | 500         | Esquema incorrecto        |
| `42703`        | Columna no existe               | 500         | Campo inexistente         |
| `22P02`        | Tipo de dato inv√°lido           | 400         | String en campo num√©rico  |
| `ECONNREFUSED` | Conexi√≥n rechazada              | 503         | BD no disponible          |
| `P2025`        | Registro no encontrado (Prisma) | 404         | Usuario inexistente       |

### **asyncHandler Explicado:**
```javascript
// Envuelve funciones async para capturar errores autom√°ticamente
export const asyncHandler = (fn) => (req, res, next) => {
  Promise.resolve(fn(req, res, next)).catch(next);
};

// Sin asyncHandler tendr√≠as que hacer esto en cada funci√≥n:
export const getUsers = async (req, res, next) => {
  try {
    const users = User.findAll();
    res.json({ success: true, data: users });
  } catch (error) {
    next(error); // ‚Üê Manualmente pasar errores
  }
};
```

---

## üìä Estructura de Datos

### **Modelo User (Simulado en Memoria):**

```javascript
// Estructura de un usuario
{
  id: 1,                                    // Autoincremental
  name: "Juan P√©rez",                       // String, min 2 caracteres
  email: "juan@email.com",                  // String, formato email v√°lido
  age: 25,                                  // Number, entre 0-120
  createdAt: "2025-09-02T10:30:00.000Z"    // ISO String, auto-generado
}
```

### **Base de Datos Simulada:**

```javascript
// Array en memoria que simula una base de datos
let users = [
  { id: 1, name: 'Juan P√©rez', email: 'juan@email.com', age: 25 },
  { id: 2, name: 'Mar√≠a Garc√≠a', email: 'maria@email.com', age: 30 },
  { id: 3, name: 'Carlos L√≥pez', email: 'carlos@email.com', age: 28 }
];

let nextId = 4; // Contador para IDs √∫nicos
```

**‚ö†Ô∏è Importante:** Los datos se resetean en cada reinicio del servidor.

---

### **Modelo Producto (PostgreSQL + Prisma):**

```javascript
// Estructura de un producto
{
  id: 1,                                    // Autoincremental (PostgreSQL)
  nombre: "Notebook Lenovo",                // String, requerido
  descripcion: "Laptop para oficina",      // String, opcional
  precio: "1200.50",                        // Decimal(10,2), requerido
  stock: 5,                                 // Integer, default 0
  createdAt: "2025-09-06T10:30:00.000Z",   // DateTime, auto-generado
  updatedAt: "2025-09-06T10:30:00.000Z"    // DateTime, auto-actualizado
}
```

### **Esquema Prisma:**

```prisma
// prisma/schema.prisma
model Producto {
  id          Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  precio      Decimal  @db.Decimal(10,2)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("Producto")
}
```

### **Tabla PostgreSQL Generada:**

```sql
CREATE TABLE "Producto" (
    "id" SERIAL NOT NULL,
    "nombre" TEXT NOT NULL,
    "descripcion" TEXT,
    "precio" DECIMAL(10,2) NOT NULL,
    "stock" INTEGER NOT NULL DEFAULT 0,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Producto_pkey" PRIMARY KEY ("id")
);
```

**‚úÖ Ventajas:** Persistencia real, validaciones de BD, respaldos autom√°ticos.

---

## üõ£Ô∏è Endpoints Disponibles

### **üè• Estado del Servidor**
| M√©todo | Endpoint | Descripci√≥n | Respuesta |
|--------|----------|-------------|-----------|
| `GET` | `/health` | Estado del servidor | `{status: "OK", timestamp, uptime}` |

### **üë• Usuarios (Simulados en Memoria)**
| M√©todo | Endpoint | Descripci√≥n | Body Requerido |
|--------|----------|-------------|----------------|
| `GET` | `/api/users` | Listar todos los usuarios | - |
| `GET` | `/api/users/:id` | Obtener usuario espec√≠fico | - |
| `POST` | `/api/users` | Crear nuevo usuario | `{name, email, age}` |
| `PUT` | `/api/users/:id` | Actualizar usuario | `{name?, email?, age?}` |
| `DELETE` | `/api/users/:id` | Eliminar usuario | - |

### **üì¶ Productos (PostgreSQL + Prisma)**
| M√©todo | Endpoint | Descripci√≥n | Body Requerido |
|--------|----------|-------------|----------------|
| `GET` | `/api/productos` | Listar todos los productos | - |
| `GET` | `/api/productos/:id` | Obtener producto espec√≠fico | - |
| `POST` | `/api/productos` | Crear nuevo producto | `{nombre, descripcion?, precio, stock}` |
| `PUT` | `/api/productos/:id` | Actualizar producto | `{nombre?, descripcion?, precio?, stock?}` |
| `DELETE` | `/api/productos/:id` | Eliminar producto | - |

### **Formato de Respuesta Est√°ndar:**

**√âxito:**
```javascript
{
  "success": true,
  "data": {...},        // Para respuestas con datos
  "count": 5,           // Para listas (opcional)
  "message": "..."      // Para acciones sin datos (opcional)
}
```

**Error:**
```javascript
{
  "success": false,
  "error": "Descripci√≥n del error",
  "stack": "..."        // Solo en desarrollo
}
```

---

## ‚öôÔ∏è Configuraci√≥n

### **Variables de Entorno (.env):**
```env
# Configuraci√≥n del servidor
NODE_ENV=development
PORT=3000
FRONTEND_URL=http://localhost:3000
API_URL=http://localhost:3000/api

# Base de datos PostgreSQL (requerido para productos)
DATABASE_URL="postgresql://username:password@localhost:5432/rest_api_db"

# Opcional: Configuraci√≥n de Prisma
PRISMA_CLI_QUERY_ENGINE_TYPE=binary
```

### **Scripts de NPM:**
```json
{
  "scripts": {
    "start": "node server.js",     // Producci√≥n
    "dev": "nodemon server.js",    // Desarrollo con auto-reload
    "lint": "eslint . --ext .js,.mjs",        // Verificar errores
    "lint:fix": "eslint . --ext .js,.mjs --fix" // Arreglar errores
  }
}
```

### **Scripts de Prisma:**
```bash
# Generar cliente Prisma (despu√©s de cambios en schema)
npx prisma generate

# Aplicar migraciones a la base de datos
npx prisma migrate dev --name descripcion_cambio

# Ver estado de migraciones
npx prisma migrate status

# Resetear base de datos (‚ö†Ô∏è elimina datos)
npx prisma migrate reset

# Abrir Prisma Studio (interfaz visual)
npx prisma studio
```

---

## üîÑ Diagrama Visual del Flujo Completo

```
üåê Cliente (Postman, Browser, App)
    ‚Üì (HTTP Request)
üì° server.js (Puerto 3000)
    ‚Üì (Carga configuraci√≥n)
üîß app.js (Middleware Stack)
    ‚îú‚îÄ‚îÄ helmet() .................... Seguridad HTTP
    ‚îú‚îÄ‚îÄ morgan() .................... Logging de requests
    ‚îú‚îÄ‚îÄ express.json() .............. Parsing del body
    ‚îú‚îÄ‚îÄ cors() ...................... Control de CORS
    ‚îî‚îÄ‚îÄ userRoutes .................. Enrutamiento
         ‚Üì (Identifica ruta espec√≠fica)
üõ£Ô∏è userRoutes.js
    ‚îú‚îÄ‚îÄ GET / ‚Üí getUsers ............ Listar todos
    ‚îú‚îÄ‚îÄ POST / ‚Üí createUser ......... Crear nuevo
    ‚îú‚îÄ‚îÄ GET /:id ‚Üí getUserById ...... Obtener uno
    ‚îú‚îÄ‚îÄ PUT /:id ‚Üí updateUser ....... Actualizar
    ‚îî‚îÄ‚îÄ DELETE /:id ‚Üí deleteUser .... Eliminar
         ‚Üì (Ejecuta l√≥gica de negocio)
üéÆ userController.js
    ‚îú‚îÄ‚îÄ Validaci√≥n de entrada ....... Campos requeridos
    ‚îú‚îÄ‚îÄ Llamada al modelo ........... Operaciones CRUD
    ‚îî‚îÄ‚îÄ Formateo de respuesta ....... Estructura est√°ndar
         ‚Üì (Acceso a datos)
üìù User.js (Modelo de datos)
    ‚îú‚îÄ‚îÄ Operaciones CRUD ............ create, read, update, delete
    ‚îú‚îÄ‚îÄ Validaci√≥n de datos ......... email, age, name
    ‚îî‚îÄ‚îÄ Simulaci√≥n de BD ............ Array en memoria
         ‚Üì (Resultado procesado)
üì§ Respuesta JSON al cliente
```

---

## üß™ Testing de la API

### **Usando el archivo api.http:**

```http
### Verificar estado del servidor
GET http://localhost:3000/health

### ========== USUARIOS (Memoria) ==========

### Obtener todos los usuarios
GET http://localhost:3000/api/users

### Crear un nuevo usuario
POST http://localhost:3000/api/users
Content-Type: application/json

{
  "name": "Ana Mart√≠nez",
  "email": "ana@email.com",
  "age": 27
}

### Obtener usuario espec√≠fico
GET http://localhost:3000/api/users/1

### Actualizar usuario
PUT http://localhost:3000/api/users/1
Content-Type: application/json

{
  "name": "Juan Carlos P√©rez",
  "age": 26
}

### Eliminar usuario
DELETE http://localhost:3000/api/users/1

### ========== PRODUCTOS (PostgreSQL) ==========

### Obtener todos los productos
GET http://localhost:3000/api/productos

### Crear nuevo producto
POST http://localhost:3000/api/productos
Content-Type: application/json

{
  "nombre": "Notebook Lenovo ThinkPad",
  "descripcion": "Laptop profesional para desarrollo",
  "precio": 1299.99,
  "stock": 8
}

### Obtener producto espec√≠fico
GET http://localhost:3000/api/productos/1

### Actualizar producto
PUT http://localhost:3000/api/productos/1
Content-Type: application/json

{
  "precio": 1199.99,
  "stock": 10
}

### Eliminar producto
DELETE http://localhost:3000/api/productos/1
```

---

## üöÄ Comandos de Inicializaci√≥n

### **Setup inicial del proyecto:**

```bash
# 1. Crear directorio e inicializar
mkdir my-express-api && cd my-express-api
npm init -y

# 2. Instalar dependencias principales
npm install express cors helmet morgan dotenv @prisma/client
npm install --save-dev nodemon prisma eslint

# 3. Crear estructura de carpetas
mkdir -p src/{controllers,models,routes,middleware,config}

# 4. Crear archivos principales
touch server.js src/app.js prisma.js .env .gitignore
touch src/controllers/userController.js
touch src/controllers/productoController.js
touch src/models/User.js
touch src/routes/userRoutes.js
touch src/routes/productoRoutes.js
touch src/middleware/errorMiddleware.js

# 5. Inicializar Prisma
npx prisma init

# 6. Configurar DATABASE_URL en .env
echo 'DATABASE_URL="postgresql://username:password@localhost:5432/rest_api_db"' >> .env

# 7. Ejecutar en desarrollo
npm run dev
```

### **üóÑÔ∏è Setup de PostgreSQL + Prisma:**

```bash
# 1. Instalar PostgreSQL en tu sistema
# macOS: brew install postgresql
# Ubuntu: sudo apt install postgresql
# Windows: Descargar desde postgresql.org

# 2. Crear base de datos
createdb rest_api_db

# 3. Configurar schema.prisma
cat > prisma/schema.prisma << 'EOF'
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Producto {
  id          Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  precio      Decimal  @db.Decimal(10,2)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
EOF

# 4. Generar migraci√≥n inicial
npx prisma migrate dev --name init

# 5. Generar cliente Prisma
npx prisma generate

# 6. (Opcional) Abrir Prisma Studio
npx prisma studio
```

### **üîß Configuraci√≥n adicional:**

```bash
# Configurar ESLint
npx eslint --init

# Agregar .gitignore
cat > .gitignore << 'EOF'
node_modules/
.env
.env.local
dist/
build/
*.log
.DS_Store
EOF

# Verificar que todo funciona
npm run dev
```

---

## üîÑ Pr√≥ximos Pasos para Expandir

### **1. Base de Datos Real:**
- **PostgreSQL + Prisma:** Para SQL (‚úÖ **Manejo de errores ya implementado**)
- **MongoDB + Mongoose:** Para NoSQL  
- **SQLite:** Para prototipado r√°pido

### **2. Autenticaci√≥n y Autorizaci√≥n:**
- **JWT (JSON Web Tokens):** Para autenticaci√≥n stateless
- **bcrypt:** Para hash de contrase√±as
- **Middleware de autenticaci√≥n:** Proteger rutas

### **3. Validaci√≥n Avanzada:**
- **Joi:** Validaci√≥n de esquemas robusta
- **express-validator:** Middleware de validaci√≥n
- **Zod:** Validaci√≥n con TypeScript

### **4. Testing:**
- **Jest:** Framework de testing
- **Supertest:** Testing de APIs HTTP
- **Testing de integraci√≥n y unitario**

### **5. Documentaci√≥n Autom√°tica:**
- **Swagger/OpenAPI:** Documentaci√≥n interactiva
- **Postman Collections:** Colecciones exportables

### **6. Optimizaci√≥n y Monitoreo:**
- **Compression:** Compresi√≥n gzip
- **Rate Limiting:** L√≠mites de peticiones
- **Health Checks:** Monitoreo del estado
- **Logging avanzado:** Winston, Pino

### **7. Deployment:**
- **Docker:** Containerizaci√≥n
- **PM2:** Process manager
- **Environment configs:** M√∫ltiples entornos

---

## üí° Conceptos Clave Aprendidos

### **1. Separation of Concerns (Separaci√≥n de Responsabilidades):**
- **server.js:** Solo inicializaci√≥n del servidor
- **app.js:** Solo configuraci√≥n de Express
- **Controllers:** Solo l√≥gica de negocio
- **Models:** Solo acceso y validaci√≥n de datos
- **Routes:** Solo definici√≥n de endpoints

### **2. Middleware Pattern:**
- **Secuencial:** Se ejecutan en orden
- **Reutilizable:** Un middleware puede usarse en m√∫ltiples rutas
- **Modular:** Cada middleware tiene una responsabilidad espec√≠fica

### **3. Error Handling Centralizado:**
- **asyncHandler:** Captura autom√°tica de errores async
- **errorMiddleware:** Manejo uniforme de errores
- **Respuestas consistentes:** Mismo formato para todos los errores

### **4. RESTful Design:**
- **Recursos:** `/api/users` representa la colecci√≥n de usuarios
- **M√©todos HTTP:** GET, POST, PUT, DELETE para CRUD
- **Status Codes:** 200, 201, 400, 404, 500 apropiados
- **Respuestas consistentes:** Mismo formato de respuesta

### **5. ES6 Modules:**
- **import/export:** Sintaxis moderna de m√≥dulos
- **"type": "module":** Habilitaci√≥n en package.json
- **Named exports:** M√∫ltiples exports por archivo
- **Default exports:** Un export principal por archivo

### **6. Prisma ORM:**
- **Type-safe queries:** Consultas con tipado autom√°tico
- **Schema-first approach:** El esquema define la estructura
- **Auto-generated client:** Cliente generado autom√°ticamente
- **Migration system:** Control de versiones de base de datos

### **7. PostgreSQL Integration:**
- **Persistent storage:** Datos que persisten entre reinicios
- **ACID transactions:** Consistencia y atomicidad de datos
- **Advanced data types:** Decimal, DateTime, etc.
- **Constraint validation:** Validaci√≥n a nivel de base de datos

### **8. Dual Storage Pattern:**
- **In-memory (Users):** R√°pido para prototipos y demos
- **Database (Products):** Robusto para datos de producci√≥n
- **Flexibility:** Permite migraci√≥n gradual entre sistemas

---

## üéØ Conclusi√≥n

Esta REST API template proporciona una base s√≥lida y escalable para construir APIs modernas con Node.js, Express, PostgreSQL y Prisma ORM. La arquitectura modular permite:

- **F√°cil mantenimiento:** C√≥digo organizado por responsabilidades
- **Escalabilidad:** Estructura que soporta crecimiento
- **Reutilizaci√≥n:** Template aplicable a diferentes proyectos
- **Mejores pr√°cticas:** Implementa patrones est√°ndar de la industria
- **Base de datos robusta:** PostgreSQL con Prisma para datos cr√≠ticos
- **Flexibilidad:** Dual storage pattern para diferentes necesidades
- **Tipado autom√°tico:** Prisma genera tipos para mejor desarrollo
- **Manejo de errores avanzado:** Espec√≠fico para PostgreSQL

### **üöÄ Lo que has logrado:**

- ‚úÖ **API REST completa** con dos recursos (usuarios y productos)
- ‚úÖ **Integraci√≥n PostgreSQL** con Prisma ORM
- ‚úÖ **Manejo de errores espec√≠fico** para PostgreSQL
- ‚úÖ **ESLint configurado** para mejor calidad de c√≥digo
- ‚úÖ **Documentaci√≥n completa** paso a paso
- ‚úÖ **Testing setup** con archivo api.http
- ‚úÖ **Arquitectura escalable** lista para producci√≥n

**¬°Ahora tienes una API completamente funcional, bien documentada y lista para usar como base en tus futuros proyectos profesionales!** üöÄ

---

*Documentaci√≥n actualizada el 6 de septiembre de 2025*  
*Template de REST API con Node.js, Express, PostgreSQL y Prisma ORM*
